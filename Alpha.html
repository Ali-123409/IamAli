<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ALPHA v8 — PWA Windsurf-style IDE</title>
<meta name="theme-color" content="#0d1117"/>
<link rel="manifest" href="#manifest" id="manifest-link">
<style>
/* ---------- theme & layout ---------- */
:root{
  --bg:#0d1117; --panel:#0f1720; --muted:#9aa4b2; --accent:#2563eb; --accent-2:#238636; --border:#232931; --card:#0b1220; --text:#dbe7ff;
  --light-bg:#f7fafc; --light-panel:#ffffff; --light-text:#0f1724; --light-border:#e6edf3; --light-card:#f3f7fa; --light-accent:#2563eb;
}
[data-theme="dark"]{ --bg:#0d1117; --panel:#0f1720; --muted:#9aa4b2; --accent:#2563eb; --border:#232931; --card:#0b1220; --text:#dbe7ff; }
[data-theme="light"]{ --bg:var(--light-bg); --panel:var(--light-panel); --muted:#52606a; --accent:var(--light-accent); --border:var(--light-border); --card:var(--light-card); --text:var(--light-text); }

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Arial;-webkit-font-smoothing:antialiased}
.app{display:flex;flex-direction:column;height:100vh;overflow:hidden}
.header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:linear-gradient(90deg,var(--panel),transparent);border-bottom:1px solid var(--border)}
.header-left{display:flex;align-items:center;gap:12px}
.header-right{display:flex;align-items:center;gap:8px}
.title{font-weight:700;font-size:18px}
.small{font-size:12px;color:var(--muted)}
.btn{background:transparent;border:1px solid var(--border);padding:7px 10px;border-radius:8px;color:var(--text);cursor:pointer}
.btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;border:none;padding:8px 12px;border-radius:8px}
.main{display:flex;flex:1;gap:12px;padding:12px;align-items:stretch;overflow:hidden}
.sidebar{width:300px;min-width:240px;display:flex;flex-direction:column;gap:12px}
.panel{background:var(--panel);border:1px solid var(--border);padding:10px;border-radius:10px;display:flex;flex-direction:column;gap:8px;box-shadow:0 6px 18px rgba(0,0,0,0.25)}
.panel-head{display:flex;justify-content:space-between;align-items:center}
.list{max-height:40vh;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:6px}
.file-item{padding:8px;border-radius:6px;background:transparent;cursor:pointer;border:1px solid transparent}
.file-item:hover{border-color:var(--border)}
.file-item.selected{background:linear-gradient(90deg, rgba(255,255,255,0.03), transparent);border-color:var(--accent)}
.editor-area{display:flex;flex:1;gap:8px;min-width:0}
.editor-pane{flex:1;display:flex;flex-direction:column;gap:8px}
.editor-toolbar{display:flex;justify-content:space-between;align-items:center}
.editorContainer{height:66vh;border-radius:10px;border:1px solid var(--border);overflow:hidden;background:linear-gradient(180deg,var(--card),#07101b);display:flex}
.editor-linenos{background:transparent;color:var(--muted);padding:10px;font-family:monospace;font-size:13px;line-height:20px;user-select:none;border-right:1px solid rgba(255,255,255,0.02)}
.editor-textarea{flex:1;border:none;background:transparent;color:var(--text);outline:none;padding:12px 14px;font-family:monospace;font-size:13px;line-height:20px;resize:none;min-height:0}
.preview-panel{width:420px;max-width:48%;display:flex;flex-direction:column;border-radius:10px;border:1px solid var(--border);background:var(--panel);transition:transform 320ms ease,opacity 320ms ease}
.preview-panel.closed{transform:translateX(18px) scale(0.98);opacity:0;pointer-events:none}
.preview-head{display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid var(--border)}
.previewFrame{width:100%;height:100%;border:none;border-top:1px solid var(--border);min-height:320px;background:#fff}
.ai-dock{position:fixed;left:14px;right:14px;bottom:14px;background:linear-gradient(180deg,var(--panel),transparent);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;z-index:40}
.ai-header{display:flex;justify-content:space-between;align-items:center}
.ai-messages{max-height:180px;overflow:auto;padding:8px;border-radius:6px;border:1px solid var(--border);background:linear-gradient(180deg,#071018,#08101a)}
.ai-input{display:flex;gap:8px}
.ai-input input{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
.footer{padding:8px;text-align:center;border-top:1px solid var(--border);font-size:12px;color:var(--muted)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:60}
.modal.hidden{display:none}
.modal-card{background:var(--panel);padding:14px;border-radius:10px;border:1px solid var(--border);width:min(1000px,94%);max-height:86vh;overflow:auto}
.diff-pre{white-space:pre-wrap;font-family:monospace;padding:8px;overflow:auto;height:320px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text)}
.kv{font-size:13px;color:var(--muted)}
.install-banner{position:fixed;right:18px;top:18px;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;padding:8px 12px;border-radius:8px;z-index:80;box-shadow:0 12px 30px rgba(0,0,0,0.35)}
@media (max-width:900px){
  .main{flex-direction:column;padding:8px}
  .sidebar{order:2;width:100%}
  .preview-panel{width:100%;order:3}
  .editorContainer{height:48vh}
  .ai-dock{left:8px;right:8px;bottom:8px}
}
</style>
</head>
<body data-theme="dark">
<div class="app" id="app">
  <header class="header">
    <div class="header-left">
      <button id="projectsBtn" class="btn">Projects</button>
      <div class="title">ALPHA v8</div>
      <div class="small" style="margin-left:6px">Local PWA IDE (Windsurf-like)</div>
    </div>
    <div class="header-right">
      <div id="networkStatus" class="small">Checking…</div>
      <button id="undoBtn" class="btn">Undo</button>
      <button id="redoBtn" class="btn">Redo</button>
      <button id="togglePreviewBtn" class="btn">Toggle Preview</button>
      <button id="settingsBtn" class="btn">Settings</button>
    </div>
  </header>

  <main class="main">
    <aside class="sidebar">
      <div class="panel">
        <div class="panel-head">
          <strong>Projects</strong>
          <button id="newProjectBtn" class="btn-primary">New</button>
        </div>
        <div id="projectList" class="list"></div>

        <div class="panel-head" style="margin-top:8px">
          <strong>Files</strong>
          <div>
            <button id="newFileBtn" class="btn">+ File</button>
            <button id="delFileBtn" class="btn">Delete</button>
          </div>
        </div>
        <div id="fileTree" class="list"></div>
      </div>

      <div class="panel">
        <strong>AI Controls</strong>
        <label class="small">Provider</label>
        <select id="providerSelect"></select>
        <label class="small" style="margin-top:6px">Options</label>
        <label><input type="checkbox" id="streamToggle" checked> Streaming</label><br/>
        <label><input type="checkbox" id="autoApplyToggle"> Auto-apply ops</label>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="explainBtn" class="btn">Explain</button>
          <button id="refactorBtn" class="btn">Refactor</button>
        </div>
      </div>
    </aside>

    <section class="editor-area">
      <div class="editor-pane panel">
        <div class="editor-toolbar">
          <div class="small">Editor — <span id="activeFileLabel">—</span></div>
          <div>
            <button id="saveBtn" class="btn-primary">Save</button>
            <button id="openPreviewTabBtn" class="btn">Open Preview</button>
          </div>
        </div>

        <div class="editorContainer" id="editorContainer">
          <div id="linenos" class="editor-linenos" aria-hidden="true">1</div>
          <textarea id="editorTextarea" class="editor-textarea" spellcheck="false" autocomplete="off"></textarea>
        </div>
      </div>

      <aside id="previewPanel" class="preview-panel closed panel">
        <div class="preview-head">
          <strong>Live Preview</strong>
          <div>
            <button id="refreshPreviewBtn" class="btn">Refresh</button>
            <button id="closePreviewBtn" class="btn">Close</button>
          </div>
        </div>
        <iframe id="previewFrame" class="previewFrame" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
      </aside>
    </section>
  </main>

  <div id="aiDock" class="ai-dock">
    <div class="ai-header">
      <strong>AI Assistant</strong>
      <span id="aiStatus" class="small">Idle</span>
    </div>
    <div id="aiMessages" class="ai-messages"></div>
    <div class="ai-input">
      <input id="aiPrompt" placeholder="Ask ALPHA — e.g., refactor index.html">
      <button id="aiSend" class="btn-primary">Send</button>
    </div>
  </div>

  <div id="settingsModal" class="modal hidden">
    <div class="modal-card">
      <h3>Settings & Providers</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div style="flex:1;min-width:320px">
          <label>Provider name</label>
          <input id="newProviderName" placeholder="My OpenAI Key" style="width:100%;padding:8px;margin:6px 0">
          <label>Type</label>
          <select id="newProviderType" style="width:100%;padding:8px;margin-bottom:6px">
            <option value="openai">OpenAI</option>
            <option value="gemini">Gemini</option>
            <option value="anthropic">Anthropic</option>
            <option value="deepseek">DeepSeek</option>
            <option value="grok">Grok</option>
          </select>
          <label>API Key</label>
          <input id="newProviderKey" placeholder="sk-..." style="width:100%;padding:8px;margin:6px 0">
          <label>Model (optional)</label>
          <input id="newProviderModel" placeholder="gpt-4o-mini or gemini-2.1" style="width:100%;padding:8px;margin-bottom:6px">
          <button id="addProviderBtn" class="btn-primary">Add Provider</button>
        </div>
        <div style="flex:1;min-width:280px">
          <label>Saved Providers</label>
          <div id="providerList" class="list" style="max-height:200px"></div>
          <label style="margin-top:8px">Theme</label>
          <select id="themeSelect" style="width:100%;padding:8px;margin:6px 0">
            <option value="auto">Auto</option><option value="dark">Dark</option><option value="light">Light</option>
          </select>
          <label class="small"><input type="checkbox" id="previewAutoToggle"> Auto-preview</label><br/>
          <label class="small"><input type="checkbox" id="streamDefaultToggle"> Streaming by default</label>
          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            <button id="closeSettings" class="btn">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="diffModal" class="modal hidden">
    <div class="modal-card">
      <h3>AI Proposed Changes — Diff Viewer</h3>
      <div id="diffOps" style="max-height:160px;overflow:auto;margin-bottom:8px"></div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <button id="acceptAllBtn" class="btn-primary">Accept All</button>
        <button id="rejectAllBtn" class="btn">Reject All</button>
        <button id="closeDiffBtn" class="btn">Close</button>
      </div>
      <div style="display:flex;gap:8px">
        <div style="flex:1"><strong>Before</strong><pre id="diffBefore" class="diff-pre"></pre></div>
        <div style="flex:1"><strong>After</strong><pre id="diffAfter" class="diff-pre"></pre></div>
      </div>
    </div>
  </div>

  <footer class="footer small">ALPHA v8 — PWA Developer Edition</footer>
</div>

<div id="installBanner" class="install-banner hidden">
  <span>Install ALPHA</span>
  <button id="installBtn" class="btn" style="margin-left:8px">Install</button>
</div>

<script>
/* =========================
   ALPHA v8 — Single-file PWA app logic
   - Editor (textarea + line numbers)
   - Project/file manager (localStorage)
   - Live preview (escaped </script>)
   - AI providers (OpenAI/Gemini/Anthropic scaffolds)
   - Streaming toggle + diff modal + undo/redo
   - Service worker registration for PWA/offline
   ========================= */

/* ---------- storage helpers ---------- */
const PREFIX = 'alpha8-';
const SETTINGS_KEY = PREFIX + 'settings';
const PROJECT_PREFIX = PREFIX + 'prj-';
const storage = {
  listProjects: () => Object.keys(localStorage).filter(k => k.startsWith(PROJECT_PREFIX)).map(k => k.replace(PROJECT_PREFIX,'')),
  loadProject: (name) => { try { const raw = localStorage.getItem(PROJECT_PREFIX + name); return raw ? JSON.parse(raw) : {}; } catch(e){ console.error('load project', e); return {}; } },
  saveProject: (name, files) => { try { localStorage.setItem(PROJECT_PREFIX + name, JSON.stringify(files||{})); } catch(e){ console.error('save project', e); } },
  loadSettings: () => { try { const raw = localStorage.getItem(SETTINGS_KEY); return raw ? JSON.parse(raw) : { providers:[], activeProvider:null, stream:true, autoApply:false, theme:'auto', previewAuto:true }; } catch(e){ return { providers:[], activeProvider:null, stream:true, autoApply:false, theme:'auto', previewAuto:true }; } },
  saveSettings: (s) => { try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); } catch(e){ console.error('save settings', e); } }
};

/* ---------- app state ---------- */
const state = {
  currentProject: null,
  files: {},
  activeFile: null,
  settings: storage.loadSettings(),
  undoStack: [],
  redoStack: []
};

/* ---------- DOM cache ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const dom = {};
function cacheDOM(){
  dom.projectList = $('#projectList');
  dom.newProjectBtn = $('#newProjectBtn');
  dom.newFileBtn = $('#newFileBtn');
  dom.delFileBtn = $('#delFileBtn');
  dom.fileTree = $('#fileTree');
  dom.providerSelect = $('#providerSelect');
  dom.addProviderBtn = $('#addProviderBtn');
  dom.providerList = $('#providerList');
  dom.newProviderName = $('#newProviderName');
  dom.newProviderType = $('#newProviderType');
  dom.newProviderKey = $('#newProviderKey');
  dom.newProviderModel = $('#newProviderModel');
  dom.settingsBtn = $('#settingsBtn');
  dom.settingsModal = $('#settingsModal');
  dom.closeSettings = $('#closeSettings');
  dom.themeSelect = $('#themeSelect');
  dom.previewPanel = $('#previewPanel');
  dom.previewFrame = $('#previewFrame');
  dom.togglePreviewBtn = $('#togglePreviewBtn');
  dom.closePreviewBtn = $('#closePreviewBtn');
  dom.refreshPreviewBtn = $('#refreshPreviewBtn');
  dom.openPreviewTabBtn = $('#openPreviewTabBtn');
  dom.editorContainer = $('#editorContainer');
  dom.linenos = $('#linenos');
  dom.editorTextarea = $('#editorTextarea');
  dom.saveBtn = $('#saveBtn');
  dom.activeFileLabel = $('#activeFileLabel');
  dom.aiMessages = $('#aiMessages');
  dom.aiPrompt = $('#aiPrompt');
  dom.aiSend = $('#aiSend');
  dom.streamToggle = $('#streamToggle');
  dom.autoApplyToggle = $('#autoApplyToggle');
  dom.autoPreviewToggle = $('#previewAutoToggle');
  dom.undoBtn = $('#undoBtn');
  dom.redoBtn = $('#redoBtn');
  dom.projectTitle = $('.title') ? document.querySelector('.title') : $('#projectTitle');
  dom.networkStatus = $('#networkStatus');
  dom.acceptAllBtn = $('#acceptAllBtn');
  dom.rejectAllBtn = $('#rejectAllBtn');
  dom.closeDiffBtn = $('#closeDiffBtn');
  dom.diffBefore = $('#diffBefore');
  dom.diffAfter = $('#diffAfter');
  dom.diffOps = $('#diffOps');
  dom.diffModal = $('#diffModal');
  dom.installBanner = $('#installBanner');
  dom.installBtn = $('#installBtn');
}

/* ---------- Editor implementation ---------- */
const Editor = (function(){
  function init(){
    updateLineNumbers();
    dom.editorTextarea.addEventListener('input', ()=>{ updateLineNumbers(); triggerChange(); });
    dom.editorTextarea.addEventListener('scroll', ()=>{ dom.linenos.scrollTop = dom.editorTextarea.scrollTop; });
    dom.editorTextarea.addEventListener('keydown', (e)=>{ if (e.key==='Tab'){ e.preventDefault(); insertAtCursor('  '); } });
  }
  let handlers = [];
  function insertAtCursor(text){
    const ta = dom.editorTextarea;
    const start = ta.selectionStart, end = ta.selectionEnd;
    const val = ta.value;
    ta.value = val.slice(0,start) + text + val.slice(end);
    ta.selectionStart = ta.selectionEnd = start + text.length;
    updateLineNumbers(); triggerChange();
  }
  function updateLineNumbers(){
    const lines = dom.editorTextarea.value.split('\n').length || 1;
    let s=''; for (let i=1;i<=lines;i++) s += i + '\n';
    dom.linenos.textContent = s;
  }
  function triggerChange(){ handlers.forEach(h=>{ try{ h({ getValue: ()=> dom.editorTextarea.value }); }catch(e){} }); }
  return {
    init, on: (ev, cb)=>{ if (ev==='change') handlers.push(cb); }, getValue: ()=>dom.editorTextarea.value, setValue: (v)=>{ dom.editorTextarea.value = v||''; updateLineNumbers(); }, focus: ()=>dom.editorTextarea.focus()
  };
})();

/* ---------- Editor change handling & preview ---------- */
let previewTimer = null;
function onEditorChange(){
  if (!state.activeFile) return;
  const content = Editor.getValue();
  if (state.files[state.activeFile] !== content) {
    state.files[state.activeFile] = content;
    if (previewTimer) clearTimeout(previewTimer);
    previewTimer = setTimeout(()=>{
      if (state.currentProject) storage.saveProject(state.currentProject, state.files);
      if (dom.autoPreviewToggle && dom.autoPreviewToggle.checked) updatePreview();
    }, 280);
  }
}

/* ---------- Build preview HTML (escape </script>) ---------- */
function buildPreviewHtml(){
  const html = state.files['index.html'] || '<h1>Empty project</h1>';
  const css = state.files['style.css'] || '';
  const js = state.files['script.js'] || '';
  const safeJs = (js||'').replace(/<\/script>/ig,'<\\/script>');
  return '<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"/><style>'+css+'</style></head><body>'+html+'\n<script>'+safeJs+'<\/script></body></html>';
}
function updatePreview(){
  try{
    const html = buildPreviewHtml();
    const blob = new Blob([html], { type:'text/html' });
    const url = URL.createObjectURL(blob);
    dom.previewFrame.src = url;
    setTimeout(()=>{ try{ URL.revokeObjectURL(url); }catch(e){} }, 20000);
  }catch(e){ console.error('updatePreview', e); }
}

/* ---------- Project & file management ---------- */
function renderProjectList(){
  dom.projectList.innerHTML = '';
  const projs = storage.listProjects();
  if (!projs.length) dom.projectList.innerHTML = '<div class="small">No projects</div>';
  projs.forEach(p=>{
    const el = document.createElement('div'); el.className='file-item'; el.textContent=p;
    el.addEventListener('click', ()=> loadProject(p));
    dom.projectList.appendChild(el);
  });
}
function renderFileTree(){
  dom.fileTree.innerHTML = '';
  const files = Object.keys(state.files||{}).sort();
  if (!files.length) dom.fileTree.innerHTML = '<div class="small">No files</div>';
  files.forEach(f=>{
    const el = document.createElement('div'); el.className='file-item'+(state.activeFile===f?' selected':''); el.textContent=f;
    el.addEventListener('click', ()=> openFile(f));
    dom.fileTree.appendChild(el);
  });
}
function newProject(){
  const name = prompt('Project name'); if (!name) return;
  if (storage.listProjects().includes(name)) { alert('Project exists'); return; }
  const files = {
    'index.html': `<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${name}</title><link rel="stylesheet" href="style.css"></head>
<body><h1>Welcome to ${name}</h1><button id="btn">Click me</button><script src="script.js"><\/script></body></html>`,
    'style.css': `body{font-family:system-ui,Arial;padding:24px}button{padding:8px 12px;border-radius:8px;background:#2563eb;color:#fff;border:none}`,
    'script.js': `document.getElementById('btn')?.addEventListener('click', ()=> alert('Hello from ${name}!'))`
  };
  storage.saveProject(name, files); renderProjectList(); loadProject(name);
}
function loadProject(name){
  state.currentProject = name; state.files = storage.loadProject(name)||{}; state.activeFile = null;
  if (document.querySelector('.title')) document.querySelector('.title').textContent = 'ALPHA v8 — ' + name;
  renderFileTree();
  const first = Object.keys(state.files)[0]; if (first) openFile(first);
  if (dom.autoPreviewToggle && dom.autoPreviewToggle.checked) updatePreview();
}
function openFile(path){
  if (!state.files[path]) return;
  state.activeFile = path; dom.activeFileLabel.textContent = path; Editor.setValue(state.files[path]||''); renderFileTree();
}
function createFile(){
  if (!state.currentProject) return alert('Open or create a project first');
  const nm = prompt('Filename (e.g., app.js)'); if (!nm) return;
  if (state.files[nm] !== undefined) return alert('File exists');
  state.files[nm] = ''; storage.saveProject(state.currentProject,state.files); renderFileTree(); openFile(nm);
}
function deleteActiveFile(){
  if (!state.activeFile) return alert('Select a file'); if (!confirm('Delete '+state.activeFile+'?')) return;
  delete state.files[state.activeFile]; state.activeFile = null; storage.saveProject(state.currentProject,state.files); renderFileTree(); Editor.setValue('');
}
function saveActiveFile(){
  if (!state.currentProject || !state.activeFile) return alert('No file open');
  const content = Editor.getValue(); state.files[state.activeFile] = content; storage.saveProject(state.currentProject,state.files); alert('Saved');
  if (dom.autoPreviewToggle && dom.autoPreviewToggle.checked) updatePreview();
}

/* ---------- Undo/Redo ---------- */
function pushUndo(){
  state.undoStack.push(JSON.parse(JSON.stringify(state.files))); if (state.undoStack.length>60) state.undoStack.shift(); state.redoStack=[];
}
function undo(){
  if (!state.undoStack.length) return alert('Nothing to undo'); state.redoStack.push(JSON.parse(JSON.stringify(state.files))); state.files = state.undoStack.pop(); storage.saveProject(state.currentProject,state.files); renderFileTree(); if (state.activeFile && state.files[state.activeFile]!==undefined) Editor.setValue(state.files[state.activeFile]); updatePreview();
}
function redo(){
  if (!state.redoStack.length) return alert('Nothing to redo'); state.undoStack.push(JSON.parse(JSON.stringify(state.files))); state.files = state.redoStack.pop(); storage.saveProject(state.currentProject,state.files); renderFileTree(); if (state.activeFile && state.files[state.activeFile]!==undefined) Editor.setValue(state.files[state.activeFile]); updatePreview();
}

/* ---------- AI provider calls (scaffolds) ---------- */
async function callProvider(provider, prompt, onToken=null, signal=null){
  if (!navigator.onLine) return { error:'Offline' };
  if (!provider || !provider.apiKey) return { error:'Provider not configured' };
  const fileList = Object.keys(state.files||{}).join(', ');
  const system = `You are ALPHA, an expert assistant inside a web IDE. Files: ${fileList}. Respond with JSON: {"thought":"...","operations":[...]}. Use EDIT_SECTION where possible.`;
  if (provider.type === 'gemini') {
    try{
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${provider.model||'gemini-2.1'}:generateContent?key=${provider.apiKey}`;
      const payload = { systemInstruction:{parts:[{text:system}]}, contents:[{parts:[{text:prompt}]}], generationConfig:{responseMimeType:'application/json'} };
      const res = await fetch(url,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload), signal});
      if (!res.ok){ const t = await res.text().catch(()=>res.statusText); throw new Error(t||'Gemini error'); }
      const data = await res.json(); const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!text) return { error:'No content' }; return JSON.parse(text);
    }catch(e){ console.error('gemini',e); return { error: e.message||e }; }
  } else if (provider.type === 'openai'){
    try{
      const url = 'https://api.openai.com/v1/chat/completions';
      const body = { model: provider.model||'gpt-4o-mini', messages:[{role:'system',content:system},{role:'user',content:prompt}], max_tokens:1500, temperature:0.2, stream: !!onToken };
      const res = await fetch(url,{method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+provider.apiKey}, body:JSON.stringify(body), signal});
      if (!res.ok){ const t = await res.text().catch(()=>res.statusText); throw new Error(t||'OpenAI error'); }
      if (onToken && res.body){
        const reader = res.body.getReader(); const dec = new TextDecoder(); let buffer='';
        while(true){
          const {done,value} = await reader.read(); if (done) break;
          const chunk = dec.decode(value,{stream:true}); buffer += chunk;
          const lines = buffer.split(/\n/); buffer = lines.pop();
          for (const line of lines){
            const trimmed = line.trim(); if (!trimmed) continue;
            if (trimmed.startsWith('data: ')){
              const payload = trimmed.replace(/^data:\s*/,''); if (payload==='[DONE]') continue;
              try{ const parsed = JSON.parse(payload); const token = parsed.choices?.[0]?.delta?.content; if (token) onToken(token); }catch(e){}
            } else onToken(trimmed);
          }
        }
        return { streamed:true, raw:buffer };
      } else {
        const data = await res.json(); const text = data?.choices?.[0]?.message?.content;
        if (!text) return { error:'No text' }; return JSON.parse(text);
      }
    }catch(e){ console.error('openai', e); return { error: e.message||e }; }
  } else if (provider.type === 'anthropic'){
    // Anthropic example (non-streaming) - user must supply API key
    try{
      const url = 'https://api.anthropic.com/v1/complete';
      const body = { model: provider.model || 'claude-2', prompt: `System: ${system}\nUser: ${prompt}`, max_tokens:1000, temperature:0.2 };
      const res = await fetch(url,{method:'POST', headers:{'Content-Type':'application/json','x-api-key':provider.apiKey}, body:JSON.stringify(body), signal});
      if (!res.ok){ const t = await res.text().catch(()=>res.statusText); throw new Error(t||'Anthropic error'); }
      const data = await res.json(); const text = data?.completion;
      if (!text) return { error:'No text' }; return JSON.parse(text);
    }catch(e){ console.error('anthropic', e); return { error: e.message||e }; }
  } else {
    return { error:'Unsupported provider type (yet)' };
  }
}

/* ---------- AI flow & UI append ---------- */
function appendAiBubble(msg){
  const el = document.createElement('div'); el.style.marginBottom='6px';
  if (msg.role==='user') el.innerHTML = `<div style="font-weight:700">You</div><div class="small">${escapeHtml(msg.text)}</div>`;
  else if (msg.role==='system') el.innerHTML = `<div style="font-weight:700">System</div><div class="small">${escapeHtml(msg.text)}</div>`;
  else el.innerHTML = `<div style="font-weight:700">ALPHA</div><div class="small" style="white-space:pre-wrap">${escapeHtml(msg.text)}</div>`;
  dom.aiMessages.appendChild(el); dom.aiMessages.scrollTop = dom.aiMessages.scrollHeight;
}
function appendAiStream(token){
  let last = dom.aiMessages.lastElementChild;
  if (!last || !last.dataset || last.dataset.stream!=='1'){
    const el = document.createElement('div'); el.dataset.stream='1'; el.innerHTML=`<div style="font-weight:700">ALPHA</div><div class="small" style="white-space:pre-wrap"></div>`; dom.aiMessages.appendChild(el); last = el;
  }
  const target = last.querySelector('.small'); target.textContent += token; dom.aiMessages.scrollTop = dom.aiMessages.scrollHeight;
}

async function sendAiPrompt(prompt){
  if (!prompt) return;
  appendAiBubble({role:'user',text:prompt});
  dom.aiPrompt.value='';
  const selected = dom.providerSelect.value;
  const provider = (state.settings.providers || []).find(p => p.name === selected);
  if (!provider) return appendAiBubble({role:'assistant',text:'No provider selected'});
  let acc='';
  function onToken(t){ acc += t; appendAiStream(t); }
  try{
    const res = await callProvider(provider, prompt, dom.streamToggle.checked ? onToken : null);
    if (res.streamed){
      try{
        const parsed = JSON.parse(acc);
        appendAiBubble({role:'assistant',text:parsed.thought || 'No thought'});
        const ops = parsed.operations || [];
        if (state.settings.autoApply){ pushUndo(); await executeOperations(ops); appendAiBubble({role:'system',text:'Applied ops'}); }
        else showDiff(ops);
      }catch(e){ appendAiBubble({role:'assistant',text:'Stream ended but JSON parse failed.'}); console.warn('stream err', acc); }
    } else if (res.error){
      appendAiBubble({role:'assistant',text:'Error: '+res.error});
    } else {
      appendAiBubble({role:'assistant',text:res.thought || 'No thought'});
      const ops = res.operations || [];
      if (state.settings.autoApply){ pushUndo(); await executeOperations(ops); appendAiBubble({role:'system',text:'Applied ops'}); }
      else showDiff(ops);
    }
  }catch(e){ console.error('sendAiPrompt', e); appendAiBubble({role:'assistant',text:'AI failed: '+(e.message||e)}); }
}

/* ---------- Diff modal ---------- */
let pendingOps=null;
function showDiff(ops){
  pendingOps = ops || [];
  dom.diffOps.innerHTML = '';
  (ops||[]).forEach(op=>{
    const row = document.createElement('div'); row.className='op-row'; row.innerHTML = `<div><strong>${escapeHtml(op.operation)}</strong> <span class="kv">${escapeHtml(op.filePath||'')}</span><div class="small">${escapeHtml((op.content||'').slice(0,200))}</div></div>`; dom.diffOps.appendChild(row);
  });
  // preview first filepath if present
  const first = (ops||[]).find(o=>o.filePath);
  if (!first){
    dom.diffBefore.textContent='No file change'; dom.diffAfter.textContent='';
  } else {
    const p = first.filePath; const before = state.files[p]||''; let after = before;
    for (const op of ops){
      if (op.filePath !== p) continue;
      const t = (op.operation||'').toUpperCase();
      if (t==='CREATE_FILE' || t==='UPDATE_FILE') after = op.content || '';
      if (t==='DELETE_FILE') after = '';
      if (t==='EDIT_SECTION'){
        if (op.useRegex){ try{ const re = new RegExp(op.find, op.flags||'g'); after = after.replace(re, op.replace||''); }catch(e){} }
        else { if (op.replaceAll) after = after.split(op.find).join(op.replace||''); else after = after.replace(op.find, op.replace||''); }
      }
    }
    dom.diffBefore.textContent = before; dom.diffAfter.textContent = after;
  }
  dom.diffModal.classList.remove('hidden');
}

/* ---------- Execute operations ---------- */
async function executeOperations(ops){
  for (const op of (ops||[])){
    const t = (op.operation||'').toUpperCase();
    switch(t){
      case 'CREATE_FILE': if (op.filePath) state.files[op.filePath] = op.content||''; break;
      case 'UPDATE_FILE': if (op.filePath) state.files[op.filePath] = op.content||''; break;
      case 'DELETE_FILE': if (op.filePath) { delete state.files[op.filePath]; if (state.activeFile === op.filePath) state.activeFile = null; } break;
      case 'EDIT_SECTION':
        if (op.filePath && state.files[op.filePath] !== undefined){
          const content = state.files[op.filePath];
          if (op.useRegex){ try{ const re=new RegExp(op.find, op.flags||'g'); state.files[op.filePath] = content.replace(re, op.replace||''); }catch(e){} }
          else { if (op.replaceAll) state.files[op.filePath] = content.split(op.find).join(op.replace||''); else state.files[op.filePath] = content.replace(op.find, op.replace||''); }
        }
        break;
      default: console.warn('unknown op', op);
    }
  }
  if (state.currentProject) storage.saveProject(state.currentProject, state.files);
  renderFileTree();
  if (state.activeFile && state.files[state.activeFile] !== undefined) Editor.setValue(state.files[state.activeFile]);
  updatePreview();
}

/* ---------- Providers UI ---------- */
function renderProviders(){
  dom.providerList.innerHTML=''; const list = state.settings.providers||[];
  list.forEach((p, idx)=>{
    const el = document.createElement('div'); el.className='file-item';
    el.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${escapeHtml(p.name)}</strong><div class="small">${escapeHtml(p.type)} • ${escapeHtml(p.model||'')}</div></div><div><button data-idx="${idx}" class="btn set-provider">Set</button></div></div>`;
    dom.providerList.appendChild(el);
  });
  dom.providerList.querySelectorAll('.set-provider').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = Number(btn.dataset.idx); state.settings.activeProvider = state.settings.providers[i]; storage.saveSettings(state.settings); renderProviders(); renderProviderSelector();
    });
  });
}
function renderProviderSelector(){
  dom.providerSelect.innerHTML=''; const ps = state.settings.providers||[];
  if (!ps.length){ dom.providerSelect.innerHTML = '<option disabled selected>No providers</option>'; return; }
  ps.forEach(p=>{ const o = document.createElement('option'); o.value=p.name; o.textContent=p.name; dom.providerSelect.appendChild(o); });
  if (state.settings.activeProvider) dom.providerSelect.value = state.settings.activeProvider.name;
  else dom.providerSelect.value = ps[0]?.name || '';
}

/* ---------- Helpers ---------- */
function updateNetworkStatus(){ dom.networkStatus.textContent = navigator.onLine ? 'Online' : 'Offline'; }
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- UI wiring ---------- */
function wireUI(){
  cacheDOM();
  Editor.init();
  dom.newProjectBtn.addEventListener('click', newProject);
  dom.newFileBtn.addEventListener('click', createFile);
  dom.delFileBtn.addEventListener('click', deleteActiveFile);
  dom.saveBtn.addEventListener('click', saveActiveFile);
  dom.refreshPreviewBtn.addEventListener('click', updatePreview);
  dom.togglePreviewBtn.addEventListener('click', ()=> dom.previewPanel.classList.toggle('closed'));
  dom.openPreviewTabBtn.addEventListener('click', ()=> { const html = buildPreviewHtml(); const w = window.open(); w.document.open(); w.document.write(html); w.document.close(); });
  dom.closePreviewBtn.addEventListener('click', ()=> dom.previewPanel.classList.add('closed'));
  dom.settingsBtn.addEventListener('click', ()=> dom.settingsModal.classList.remove('hidden'));
  dom.closeSettings.addEventListener('click', ()=> dom.settingsModal.classList.add('hidden'));
  dom.addProviderBtn.addEventListener('click', ()=> {
    const name = dom.newProviderName.value.trim(); const type = dom.newProviderType.value; const key = dom.newProviderKey.value.trim(); const model = dom.newProviderModel.value.trim();
    if (!name || !key) return alert('name & key required');
    state.settings.providers = state.settings.providers || []; state.settings.providers.push({ name, type, apiKey:key, model }); if (!state.settings.activeProvider) state.settings.activeProvider = state.settings.providers[0];
    storage.saveSettings(state.settings); renderProviders(); renderProviderSelector();
    dom.newProviderName.value = dom.newProviderKey.value = dom.newProviderModel.value = '';
  });
  dom.providerSelect.addEventListener('change', ()=> { const pname = dom.providerSelect.value; state.settings.activeProvider = (state.settings.providers||[]).find(p=>p.name===pname) || null; storage.saveSettings(state.settings); });
  dom.aiSend.addEventListener('click', ()=> sendAiPrompt(dom.aiPrompt.value));
  dom.aiPrompt.addEventListener('keydown', (e)=> { if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendAiPrompt(dom.aiPrompt.value); } });
  dom.undoBtn.addEventListener('click', ()=> undo());
  dom.redoBtn.addEventListener('click', ()=> redo());
  window.addEventListener('keydown',(e)=>{ if ((e.ctrlKey||e.metaKey)&&e.key==='s'){ e.preventDefault(); saveActiveFile(); } if ((e.ctrlKey||e.metaKey)&&e.key==='k'){ e.preventDefault(); dom.aiPrompt.focus(); } if ((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); sendAiPrompt(dom.aiPrompt.value); }});
  Editor.on && Editor.on('change', onEditorChange);

  $('#acceptAllBtn').addEventListener('click', async ()=> { if (!pendingOps) return; pushUndo(); await executeOperations(pendingOps); pendingOps=null; dom.diffModal.classList.add('hidden'); appendAiBubble({role:'system',text:'Applied all ops'}); });
  $('#rejectAllBtn').addEventListener('click', ()=> { pendingOps=null; dom.diffModal.classList.add('hidden'); appendAiBubble({role:'system',text:'Rejected ops'}); });
  $('#closeDiffBtn').addEventListener('click', ()=> dom.diffModal.classList.add('hidden'));

  // Install PWA prompt handling
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', (e)=> { e.preventDefault(); deferredPrompt = e; dom.installBanner.classList.remove('hidden'); });
  dom.installBtn && dom.installBtn.addEventListener('click', async ()=> { if (!deferredPrompt) return; deferredPrompt.prompt(); const choice = await deferredPrompt.userChoice; deferredPrompt = null; dom.installBanner.classList.add('hidden'); });

  updateNetworkStatus(); window.addEventListener('online', updateNetworkStatus); window.addEventListener('offline', updateNetworkStatus);
}

/* ---------- Boot ---------- */
document.addEventListener('DOMContentLoaded', ()=> {
  cacheDOM(); Editor.init(); wireUI();
  state.settings = Object.assign({ providers:[], activeProvider:null, stream:true, autoApply:false, theme:'auto', previewAuto:true }, storage.loadSettings());
  applyTheme(state.settings.theme || 'auto');
  renderProjectList(); renderProviders(); renderProviderSelector();
  const projs = storage.listProjects(); if (projs.length) loadProject(projs[0]);
});

/* ---------- Theme helper ---------- */
function applyTheme(pref){
  if (pref === 'auto'){
    const dark = window.matchMedia && window.matchMedia('(prefers-color-scheme:dark)').matches;
    document.body.setAttribute('data-theme', dark ? 'dark' : 'light');
  } else document.body.setAttribute('data-theme', pref);
}

/* ---------- service worker registration (inline) ---------- */
if ('serviceWorker' in navigator){
  // register a simple service worker created from a blob so the whole app is one file
  const swCode = `
    const CACHE = 'alpha8-cache-v1';
    const ASSETS = ['./'];
    self.addEventListener('install', e=>{ self.skipWaiting(); e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS))); });
    self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', e=> {
      // Try network first for API calls, otherwise serve from cache
      const url = new URL(e.request.url);
      if (url.origin !== location.origin) return; // do not intercept cross-origin
      e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(()=>caches.match('/'))));
    });
  `;
  const blob = new Blob([swCode], { type:'application/javascript' });
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).then(()=>console.log('SW registered')).catch(e=>console.warn('SW failed', e));
}

/* ---------- small helpers ---------- */
function $(s){ return document.querySelector(s); }
function escapeHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

</script>
</body>
</html>